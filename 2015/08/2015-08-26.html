<!DOCTYPE html><!--[if lte IE 8]>
<html lang="en" class="lte-ie8">
<![endif]-->
<!--[if gt IE 8]><!-->
<html lang="en">
<!--<![endif]--><head><meta charset="utf-8"><title>August 25, 2015</title><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/dear-diary/styles/global.css"><link rel="stylesheet" href="/dear-diary/styles/tomorrow.css"><link rel="stylesheet" href="/dear-diary/styles/diary.css"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-63818301-1', 'auto');
ga('send', 'pageview');</script></head><body><header class="header"><div class="index"><a href="/dear-diary/">Index</a></div><h1>August 25, 2015</h1></header><div class="content"><div class="diary"><h2 id="js-v8">JS/V8</h2>
<h3 id="optimization-killers"><a href="https://github.com/petkaantonov/bluebird/wiki/Optimization-killers">Optimization killers</a></h3>
<ul>
<li>Inner functions that contain pattern for bailout will affect the containing function</li>
</ul>
<h4 id="how-to-check-for-optimization">How to check for optimization</h4>
<ol>
<li>Make a function that contains the pattern</li>
<li>The return value of <code>%GetOptimizationStatus(fn)</code> shows to what degree is the function <code>fn</code> optimized.</li>
<li>Call it two times to go from <code>uninitialized</code> to <code>monomorphic</code></li>
<li>Use <code>%OptimizeFunctionOnNextCall(fn)</code> to instruct V8 to optimize this function immediately</li>
<li>Run it with <code>node --trace_opt --trace_deopt --allow-natives-syntax</code></li>
</ol>
<h4 id="patterns">Patterns</h4>
<ul>
<li>Note: even if the code is not reachable, it will still prevent the containing function from being optimized</li>
<li>Currently not optimizable<ul>
<li><code>yield</code> and <code>function *()</code></li>
<li><code>for..of</code></li>
<li><code>try..catch</code> or <code>try..finally</code></li>
<li>compound <code>let</code></li>
<li>compound <code>const</code></li>
<li><code>__proto__</code>, <code>get</code>, <code>set</code></li>
<li><code>switch</code> with more than 128 <code>case</code></li>
</ul>
</li>
<li>Likely never optimizable<ul>
<li><code>debugger</code></li>
<li><code>eval()</code></li>
<li><code>with</code></li>
</ul>
</li>
<li><code>eval()</code> and <code>with</code> breaks lexical scoping</li>
<li>Workarounds<ul>
<li>Break unoptimizable code into minimal functions so the callee won&#39;t be affected</li>
<li>e.g. return different results in <code>try..catch</code>, let the callee use the return value to decide what to do next</li>
</ul>
</li>
</ul>
<h4 id="arguments"><code>arguments</code></h4>
<ul>
<li><p>Reassigning a defined parameter while also mentioning <code>arguments</code> in the body, e.g. </p>
<pre><code class="lang-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">defaultArgsReassign</span>(<span class="hljs-params">a, b</span>) </span>{
     <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">2</span>) b = <span class="hljs-number">5</span>;
}
</code></pre>
<p>Solution:</p>
<ul>
<li>Leave the argument, use a copy and reassign to that copy</li>
<li>Just checking for <code>undefined</code> is enough in many cases</li>
<li>Enable <code>use strict</code></li>
</ul>
</li>
<li>Leaking <code>arguments</code> to somewhere else e.g. return it, pass it to another function, put it in closure<ul>
<li>Solution: copy to an array</li>
<li>Bluebird has a macro in the build step to do this</li>
</ul>
</li>
<li>Assigning to <code>arguments</code><ul>
<li>Why would you do that anyway?!</li>
</ul>
</li>
<li>Calling methods on <code>arguments</code> e.g. <code>arguments.slice</code></li>
<li>Safe <code>arguments</code> usage<ul>
<li><code>argument.length</code></li>
<li><code>argument[i]</code> where <code>i</code> is valid and not out-of-bound</li>
<li><code>x.apply(y, arguments)</code>(<code>Function#apply</code> is special)</li>
</ul>
</li>
</ul>
<h4 id="for-in">For-in</h4>
<ul>
<li>When the key is not local(referenced from outer scope/referenced in inner scope)</li>
<li>When the iterated object is in dictionary mode<ul>
<li>Added a lot of properties dynamically(outside constructor)</li>
<li><code>delete</code> properties</li>
<li>Keys that can&#39;t be identifiers(note: digits!)</li>
<li>Use <code>%HasFastProperties(obj)</code> to check for this</li>
</ul>
</li>
<li>There are enumerable properties on the prototype chain<ul>
<li><code>Object.prototype.fn = function() {};</code></li>
<li>Use <code>Object.defineProperty</code> to make it unenumerable</li>
</ul>
</li>
<li>Use <code>Object.keys</code> to avoid <code>for-in</code>. If you do need it, make it isolated in a small function</li>
</ul>
<h4 id="infinite-loops">Infinite loops</h4>
<ul>
<li><code>while(true)</code> / <code>for (;;)</code> with deep logic exit conditions or unclear exit conditions</li>
<li>Make the exit condition clearer</li>
<li>Make the logic shallow</li>
</ul>
<h4 id="resources">Resources</h4>
<ul>
<li>A good documentation on V8 runtime functions: <a href="https://github.com/thlorenz/v8-runtime-functions">thlorenz/v8-runtime-functions</a></li>
</ul>
</div></div><footer class="footer"><address class="author">Copyright &copy;<a rel="author" href="https://github.com/joyeecheung" class="author-name">Joyee Cheung</a>-<a href="https://github.com/joyeecheung/my-tech-diary" class="source-repo">Source</a></address><p>Generated by<a href="https://github.com/joyeecheung/diary" class="site-repo">Joyee Cheung&#39;s diary generator</a></p></footer></body></html>